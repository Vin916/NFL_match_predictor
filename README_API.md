# NFL Predictor REST API

A Flask-based REST API that serves NFL game predictions using ensemble machine learning models.

## Quick Start

### Option 1: Deploy Script

```bash
cd NFL_match_predictor
./deploy.sh
```

This will train models, build the Docker image, and start the API on http://localhost:8080

### Option 2: Manual Setup

```bash
# Install dependencies
pip install -r requirements.txt

# Train and save models
python3 train_and_save_model.py

# Start the Flask API
python3 app.py
```

## API Endpoints

### Health Check
```
GET /health
```
Returns API status and loaded models information.

### Get Available Teams
```
GET /teams
```
Returns list of all NFL teams available for predictions.

### Predict Game Outcome
```
POST /predict_game
Content-Type: application/json

{
  "home_team": "KC",
  "away_team": "BUF"
}
```

**Response:**
```json
{
  "home_team": "KC",
  "away_team": "BUF",
  "predicted_winner": "KC",
  "home_win_probability": 0.65,
  "confidence": 0.65,
  "confidence_percent": "65.0%",
  "individual_votes": {
    "Logistic Regression": "KC",
    "Decision Tree": "KC", 
    "Random Forest": "BUF"
  },
  "team_stats": {
    "home": {
      "points_per_game": 28.5,
      "points_allowed_per_game": 18.2,
      "win_percentage": 0.75
    },
    "away": {
      "points_per_game": 25.1,
      "points_allowed_per_game": 21.5,
      "win_percentage": 0.65
    }
  }
}
```

### Predict Weekly Games
```
POST /predict_week
Content-Type: application/json

{
  "season": 2025,
  "week": 5
}
```

**Response:**
```json
{
  "season": 2025,
  "week": 5,
  "games": [
    {
      "home_team": "KC",
      "away_team": "BUF",
      "predicted_winner": "KC",
      "confidence": 0.65,
      "individual_votes": {...},
      "game_completed": true,
      "home_score": 27,
      "away_score": 24,
      "actual_winner": "KC",
      "prediction_correct": true
    }
  ],
  "accuracy_stats": {
    "total_games": 14,
    "completed_games": 14,
    "correct_predictions": 9,
    "accuracy_percentage": 64.3
  }
}
```

### Predict from Raw Features
```
POST /predict
Content-Type: application/json

{
  "features": [25.5, 22.1, 3.4, 18.2, 21.5, -3.3, 0.5, 0.5, 0.0, 0.65, 0.45, 0.2]
}
```

**Response:**
```json
{
  "prediction": 1,
  "home_win_probability": 0.68,
  "confidence": 0.68,
  "individual_votes": {
    "Logistic Regression": 1,
    "Decision Tree": 1,
    "Random Forest": 0
  }
}
```

## Docker Deployment

### Build and Run Locally
```bash
# Build the image
docker build -t nfl-predictor .

# Run locally
docker run -p 8080:8080 nfl-predictor

# Run in background
docker run -d -p 8080:8080 --name nfl-api nfl-predictor
```

### Deploy to Google Cloud Run
```bash
# Build and push to Google Container Registry
gcloud builds submit --tag gcr.io/YOUR_PROJECT_ID/nfl-predictor

# Deploy to Cloud Run
gcloud run deploy nfl-predictor \
  --image gcr.io/YOUR_PROJECT_ID/nfl-predictor \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --memory 2Gi \
  --cpu 1
```

## Testing

### Run Test Suite
```bash
python3 test_api.py
```

### Manual Testing with curl

**Health Check:**
```bash
curl http://localhost:8080/health
```

**Get Teams:**
```bash
curl http://localhost:8080/teams
```

**Predict Game:**
```bash
curl -X POST http://localhost:8080/predict_game \
  -H "Content-Type: application/json" \
  -d '{"home_team": "KC", "away_team": "BUF"}'
```

**Predict Week:**
```bash
curl -X POST http://localhost:8080/predict_week \
  -H "Content-Type: application/json" \
  -d '{"season": 2025, "week": 10}'
```

## Architecture

### Models
| Model | Description |
|-------|-------------|
| Logistic Regression | Linear probability model |
| Decision Tree | Rule-based predictions |
| Random Forest | Ensemble of decision trees |
| Ensemble Voting | Combines all models for final prediction |

### Features (12 total)
- Points scored per game (home/away/differential)
- Points allowed per game (home/away/differential)
- Home field advantage (home/away/differential)
- Win percentage (home/away/differential)

### Data Weighting
- **90%**: Current season performance
- **10%**: Previous season baseline
- Automatically updates as more games are played

### Historical Predictions
When predicting past weeks, the system only uses data from weeks *before* the target week. This ensures predictions reflect what the model would have known at that time.

## Model Artifacts

Required files (generated by `train_and_save_model.py`):
- `model_logistic_regression.pkl`
- `model_decision_tree.pkl`
- `model_random_forest.pkl`
- `scaler.pkl`
- `feature_columns.pkl`

## Performance

- **Training Data**: 2022-2024 NFL seasons (~1,000+ games)
- **Model Accuracy**: ~55-65% on test data
- **Response Time**: <100ms per prediction
- **Memory Usage**: ~500MB with all models loaded

## Error Handling

HTTP status codes:
- `200`: Success
- `400`: Bad request (missing/invalid parameters)
- `500`: Internal server error

Error response format:
```json
{
  "error": "Team not found: INVALID_TEAM"
}
```

## Updating Models

```bash
# Retrain with latest data
python3 train_and_save_model.py

# Restart the API
docker restart nfl-api
```
